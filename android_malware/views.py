# -*- coding: utf-8 -*-
from __future__ import unicode_literals

import os
import time
# import android_malware.search.apkpure
# import android_malware.search.anzhi
from android_malware.search.apkpure import ApkPuredownMain
from android_malware.search.anzhi import AnzhiDownMain
from android_malware.search.mi import miDownMain
# from android_malware.search.apkpure import ApkPuredownMain
# from search.anzhi import AnzhiDownMain
from django.contrib import messages
from _datetime import datetime

from Weka_Model.MAIN import MAIN
from Weka_Model.permission2 import permission2
from django.shortcuts import render
from django.views.decorators.csrf import csrf_exempt


# Create your views here.
@csrf_exempt
def index(request):
    if request.method == 'POST':
            file_obj = request.FILES.get("up_file", False)
            if 'apk' not in str(file_obj.name):
                messages.add_message(request, messages.ERROR, 'Please upload an apk file.')
                return render(request, "index.html", locals())
            # analyze_method = request.get("Radios")
            # 依據上傳檔案時間, ip來新建使用者資料夾
            ip = request.META['REMOTE_ADDR']
            time1 = time.strftime("%Y%m%d%H%M%S")

            # 資料夾檔名
            time1_ip = time1+"_"+ip

            os.system('cd apk_file')
            os.system('mkdir Weka_Model/apk_file/'+time1_ip)
            path = "Weka_Model/apk_file/"+time1+"_"+ip+"/"+file_obj.name
            # 新建檔案存取使用者上傳的檔案
            with open(path, "wb") as f1:
                for i in file_obj.chunks():
                    f1.write(i)

            permission2(time1_ip)
            apk_result, result_time = MAIN(file_obj.name)
            analyze_time = datetime.strptime(result_time, '%Y%m%d%H%M%S') - datetime.strptime(time1, '%Y%m%d%H%M%S')

    # template = get_template('index.html')
    # html = template.render(locals())
    # return HttpResponse(html)
    return render(request, "index.html", locals())
    # return render_to_response('index.html',context_instance=RequestContext(request))

@csrf_exempt
def downApk(request):
    if request.method == 'POST':
        select = request.POST['drop']
        print(select)
        input = request.POST['input_apkName']
        print(input)

        # 資料夾檔名
        ip = request.META['REMOTE_ADDR']
        time1 = time.strftime("%Y%m%d%H%M%S")
        time1_ip = time1 + "_" + ip

        os.system('mkdir Weka_Model/apk_file/' + time1_ip)

        # 判斷為哪個第三方市集
        if select == "2":
            result = miDownMain(input, time1_ip)
        elif select == "3":
            result = AnzhiDownMain(input, time1_ip)
        else:
            result = ApkPuredownMain(input, time1_ip)

        permission2(time1_ip)
        apk_result, result_time = MAIN(result + '.apk')
        analyze_time = datetime.strptime(result_time, '%Y%m%d%H%M%S') - datetime.strptime(time1, '%Y%m%d%H%M%S')

    return render(request, "apk.html", locals())
    # return render_to_response('index.html',context_instance=RequestContext(request))




