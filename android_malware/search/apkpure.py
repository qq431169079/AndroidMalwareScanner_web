# -*- coding: utf-8 -*-

from bs4 import BeautifulSoup
# from urllib.request import urlopen
import urllib.request

# 爬網方法
def set_url(url, headers, Name):
    req = urllib.request.Request(url=url, headers=headers)

    # 開始爬網
    html = urllib.request.urlopen(req).read()
    soup = BeautifulSoup(html, features='lxml')

    # 開始分析格式
    link = soup.find(class_=Name)
    # 取得apk下載頁面
    return link.get('href')

# 用request, 下載apk
def down_apk(url, headers, path):
    try:
        req = urllib.request.Request(url, headers=headers)
        data = urllib.request.urlopen(req).read()
        with open(path, 'wb') as f:
            f.write(data)
            f.close()
    except Exception as e:
        print(str(e))

# 比對搜尋結果
def compare(url, headers):
    req = urllib.request.Request(url=url, headers=headers)

    html = urllib.request.urlopen(req).read()
    soup = BeautifulSoup(html, features='lxml')

    # 開始分析格式
    divs = soup.find_all('p', 'search-title')
    for d in divs:
        if(d.find(href= set_url(url, headers, 'more-down'))!=None):
            result = d.find(href= set_url(url, headers, 'more-down')).getText()
            return result
        break

def ApkPuredownMain(apkname, time1_ip):
    # 設定參數
    apkname = apkname.lower()
    url = "https://apkpure.com/tw/search?q=" + apkname
    # 在header加入瀏覽器身份
    headers = {
        'User-Agent':
        'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:23.0) Gecko/20100101 Firefox/23.0'
    }
    # 取得apk_href
    apk_url = 'https://apkpure.com' + set_url(url, headers, 'more-down')
    # 切出 apkname
    devide = set_url(url, headers, 'more-down').split('/')
    apkname = devide[3].lower()
    print(apkname)

    down_url = 'https://apkpure.com' + set_url(apk_url, headers, 'da')
    file_url = set_url(down_url, headers, 'ga')

    print(file_url)
    path = "/home/ymlab/PycharmProjects/untitled4/Weka_Model/apk_file/" + time1_ip + '/'
    down_apk(file_url, headers, path + apkname + '.apk')

    print("Succeeded")
    return apkname