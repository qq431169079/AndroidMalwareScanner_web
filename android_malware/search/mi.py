# -*- coding: utf-8 -*-
from bs4 import BeautifulSoup
# from urllib.request import urlopen
import urllib.request
import datetime
# 設定參數

# # 輸入 url
# str = input("your download url : ")

# # 切出 apkname
# devide = str.split('=',1)
# apkname = devide[1].lower()
def miDownMain(apkname, time1_ip):
    # 搜尋 url + APP
    url = "http://app.mi.com/search?keywords=" + urllib.parse.quote(apkname)
    print(url)
    path = "/home/ymlab/PycharmProjects/untitled4/Weka_Model/apk_file/" + time1_ip + '/'

    # 發 request
    req = urllib.request.Request(url)

    # 用 'utf8' 解讀拿到的 html
    html = urllib.request.urlopen(req).read().decode('utf8')

    # 用 BeautifulSoup 排版
    soup = BeautifulSoup(html, features='html.parser')

    #找到標籤 <applist>
    downloadLink = soup.find(class_='applist').a.get('href')
    print(downloadLink)

    # 切出 apkname
    devide = downloadLink.split('=',1)
    apkname = devide[1].lower().replace('&ref=search', '')
    print(apkname)

    # 下載 url + APP
    url = 'http://app.mi.com'+ downloadLink

    # 發 request
    req = urllib.request.Request(url)

    # 用 'utf8' 解讀拿到的 html
    html = urllib.request.urlopen(req).read().decode('utf8')

    # 用 BeautifulSoup 排版
    soup = BeautifulSoup(html, features='html.parser')

    #找到標籤 <a>  <class download >
    downloadLink = soup.find('a',class_= 'download')

    #做點擊 <href>
    targetLink = "http://app.mi.com" + downloadLink.get('href')
    print(targetLink)

    #再次 request
    req2 = urllib.request.Request(targetLink)
    # 存下來、寫入
    data = urllib.request.urlopen(req2).read()
    with open(path+apkname+".apk", 'wb') as f:
        f.write(data)
        f.close()
    print("OK")
    return apkname
