# -*- coding: utf-8 -*-

from bs4 import BeautifulSoup
# from urllib.request import urlopen
import urllib.request
import re
import os

# 爬網方法
def set_url(url, headers):
    req = urllib.request.Request(url=url, headers=headers)

    # 開始爬網
    html = urllib.request.urlopen(req).read()
    soup = BeautifulSoup(html, features='lxml')

    # 開始分析格式
    link = soup.find(href="javascript:void(0)")
    # 取得apk下載數字
    return link.get('onclick')

# 用request, 下載apk
def down_apk(url, headers, path):
    try:
        req = urllib.request.Request(url, headers=headers)
        data = urllib.request.urlopen(req).read()
        with open(path, 'wb') as f:
            f.write(data)
            f.close()
    except Exception as e:
        print(str(e))


def AnzhiDownMain(apkname, time1_ip):
    # 設定參數
    apkname = apkname.lower()

    # 爬蟲 url不能存在中文，因為request套件預設編碼為ASCII，解析不了中文字串，所以使用urllib.parse.quote()
    url = "http://www.anzhi.com/search.php?keyword=" + urllib.parse.quote(apkname)
    path = "/home/ymlab/PycharmProjects/untitled4/Weka_Model/apk_file/" + time1_ip + '/'
    # 在header加入瀏覽器身份
    headers = {
        'User-Agent':
            'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:23.0) Gecko/20100101 Firefox/23.0'
    }

    str = re.findall(r"\d+", set_url(url, headers))
    file_url = 'http://www.anzhi.com/dl_app.php?s=' + str[0] + "&n=5"
    print(file_url)
    down_apk(file_url, headers, path + apkname + '.apk')
    # print(os.path.getsize(apkname + '.apk'))
    print(apkname + '.apk')

    print("Succeeded")
    return apkname