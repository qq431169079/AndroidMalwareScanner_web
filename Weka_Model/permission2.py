#!/usr/bin/python
#-*- coding: utf-8 -*-

import subprocess, sys,time ,xlrd ,os,csv, shutil
from os.path import join
from typing import List, Tuple, Iterator

def permission2(time1_ip):
    DATA_OUTDIR = "/home/ymlab/PycharmProjects/untitled4/Weka_Model/"
    #將各樣本權限與baseline進行比對
    apkfiles =  os.walk(DATA_OUTDIR + 'apk_file/'+ time1_ip)
    # apkfiles =  os.walk(time1_ip)

    permissionlistall=[] #紀錄csv第一列資訊

    Spermission=""
    Spermissions=[]
    samplefeature = []
    sampledata=[]


    f2 = open(DATA_OUTDIR+"permissionforTest.csv", "w", newline='')

    a = csv.writer(f2)
    data2 = open(DATA_OUTDIR+"NEWpermissionhead.csv", mode="r", encoding="utf-8")
    reader = csv.reader(data2, delimiter=',')
    for row in reader:
        permissionlist=row
        permissionlistall.append(permissionlist) #權限baseline暫存於permissionlistall
    data2.close()
    a.writerows(permissionlistall) #baseline寫入permissionfv.csv (第一列)

    data=open(DATA_OUTDIR+"NEWpermissionsvalid.csv", mode='r', encoding='utf-8') #讀取剛才寫入permissions.csv裡的權限baseline
    reader = csv.reader(data, delimiter=',')
    for row in reader:
        permissionlist=row
    data.close()


    for root, dirs, files in apkfiles:

        for apk in files:
            fullpath = join(root, apk) #root為檔案路徑，apk為檔案名稱
            # print(fullpath)
            cmd="/home/ymlab/Android/Sdk/build-tools/27.0.3/aapt dump permissions " + fullpath
            r=subprocess.check_output(cmd, shell=True)

            manifest=r.decode("utf-8") #先轉碼

            Spermission=manifest.split("\n")
            for i in range(len(Spermission)):
                if i > 0 and i != len(Spermission)-1:  #去頭(package name)去尾(空直)
                    if not Spermission[i] in Spermissions:
                        Spermissions.append(Spermission[i])

            samplefeature.append(apk) #samplefeature紀錄每個樣本的特徵，第一欄為樣本名稱
            for i in range(len(permissionlist)):
                if i > 0:        #第一欄(i=0)為樣本名稱，不用比對
                    value = permissionlist[i]
                    if i == len(permissionlist)-1: #class 要空的所以最後田空白
                        samplefeature.append(' ')
                        break
                    if value in Spermissions: #如第i欄的baseline此樣本有用過則紀錄為1
                        samplefeature.append('1')
                    if value not in Spermissions:  #如第i欄的baseline此樣本沒用過則紀錄為0
                        samplefeature.append('0')

            sampledata.append(samplefeature)
            a.writerows(sampledata) #寫入樣本名及連線domain

            #清空list 因為要重複使用
            sampledata.clear()
            samplefeature.clear()
            Spermissions.clear()
            # print("-------------------------------------------------")
    f2.close()

            